name: '$(Build.BuildId)'
variables:
  BUILD_CONFIGURATION: 'Release'
  
  FUNCTION_PUBLISH_DIRECTORY: '$(Build.SourcesDirectory)/function-app'
  FUNCTION_DIRECTORY: '$(Build.SourcesDirectory)/src/Realtime.Presenter.Function'
  ARCHIVED_FUNCTION_PATH: '$(Build.ArtifactStagingDirectory)/Realtime.Presenter.Function.zip'

  WEB_DIRECTORY: '$(Build.SourcesDirectory)/src/Realtime.Presenter.Web'
  WEB_PUBLISH_DIRECTORY: '$(Build.SourcesDirectory)/src/Realtime.Presenter.Web/dist'
  WEB_ARTIFACTS_DIRECTORY: '$(Build.ArtifactStagingDirectory)/website'
  
  FUNCTION_TESTS_DIRECTORY: '$(Build.SourcesDirectory)/tests/Realtime.Presenter.Function.Tests'
  MOBILE_TESTS_DIRECTORY: '$(Build.SourcesDirectory)/tests/Realtime.Presenter.Mobile.Tests'
jobs:
- job: CI
  displayName: CI
  pool: 
    vmImage: 'macOS-10.14'
  workspace:
    clean: all
  steps:
  - task: NuGetToolInstaller@0
    displayName: Install NuGet

  - task: NodeTool@0
    displayName: Install Node 10
    inputs:
      versionSpec: '10.x'

  - bash: npm install --global yarn
    displayName: Install Yarn

  - task: NuGetCommand@2
    displayName: Restore NuGet Packages
    inputs:
      restoreSolution: '**/*.sln'

  - bash: yarn
    displayName: Install Node Packages
    workingDirectory: '$(WEB_DIRECTORY)'

  - task: DotNetCoreCLI@2
    displayName: Function Tests
    inputs:
      command: 'test'
      configuration: '$(BUILD_CONFIGURATION)'
      workingDirectory: '$(FUNCTION_TESTS_DIRECTORY)'
      
  - task: DotNetCoreCLI@2
    displayName: Forms Tests
    inputs:
      command: 'test'
      configuration: '$(BUILD_CONFIGURATION)'
      workingDirectory: '$(MOBILE_TESTS_DIRECTORY)'

  - bash: yarn test
    displayName: Web Tests
    workingDirectory: '$(WEB_DIRECTORY)'

  - task: DotNetCoreCLI@2
    displayName: Publish Function
    inputs:
      command: 'publish'
      arguments: '--output $(FUNCTION_PUBLISH_DIRECTORY)'
      configuration: '$(BUILD_CONFIGURATION)'
      publishWebProjects: false
      workingDirectory: '$(FUNCTION_DIRECTORY)'
  
  - bash: yarn build
    displayName: Publish Website
    workingDirectory: '$(WEB_DIRECTORY)'
  
  - task: ArchiveFiles@2
    displayName: Package Function
    inputs:
      rootFolderOrFile: '$(FUNCTION_PUBLISH_DIRECTORY)'
      includeRootFolder: false
      archiveFile: '$(ARCHIVED_FUNCTION_PATH)'

  - task: CopyFiles@2
    displayName: Copy Website
    inputs:
      sourceFolder: '$(WEB_PUBLISH_DIRECTORY)'
      targetFolder: '$(WEB_ARTIFACTS_DIRECTORY)'

  - bash: ./deploy-app.sh
    displayName: Deploy Function App
    env:
      AZURE_USERNAME: $(AZURE_USERNAME)
      AZURE_PASSWORD: $(AZURE_PASSWORD)

  - task: PublishBuildArtifacts@1
    displayName: Publish Artifacts